<!--
  ref. 
    * https://material.io/guidelines/components/menus.html#menus-specs
    * https://material.io/components/web/catalog/menus/

  observable attribute
   * visible

  Requirements
    # observable attribute
      . visible
    # styling
      . z-index: 8
      . shadow: 1
      . padding: 8px 0px
    # positionalble: bottom-right, top-right,bottom-left(default), top-left
    # one DOM, one menu display
    # hide DOM, when DOM element clicked
    # TODO: multi-level meu
    # TODO: respond to menu item changed

  Bug: 
    # css animation is not right
-->
<template for="Menu">
  <style id="a-menu-style">
  a-menu {
    background-color: var(--theme-color-0, #ffffff);
    box-shadow: var(--theme-shadow-1dp,  0   1px  3px rgba(0,0,0,0.12), 0  1px  2px rgba(0,0,0,0.24));
    color: var(--theme-text-color-900, #212121);
    font-size: 16px;
    overflow-y: auto;
    padding: 8px 0px;
    position: absolute;
    z-index: 8;
  }
  a-menu:not([visible]) {
    visibility: hidden;
  }
  a-menu[visible] {
    display: block;
    visibility: visible;
  }
  a-menu[position=bottom-right] {
    right: 16px;
    top: 48px;
  }
  a-menu[position=bottom-left] {
    left: 16px;
    top: 48px;
  }
  a-menu[position=top-right] {
    right: 16px;
    bottom: 48px;
  }
  a-menu[position=top-left] {
    left: 16px;
    bottom: 48px;
  }
  a-menu hr, 
  a-menu .divider {
    display: block;
    margin: 4px 0px;
    height: 1px;
    border: 1px solid #ccc;
    border-width: 0 0 1px 0;
  }
  </style>
</template>

<script>
( function() {
  var thisScript = document.currentScript;

  class Menu extends HTMLElement {
    constructor() {
      super();
      this._init();
    }

    _init() {
      let template = thisScript.ownerDocument.querySelector('template[for=Menu]');
      let style = template.content.querySelector('style').cloneNode(true);
      !document.querySelector(`#ce-core-style, #${style.id}`) && document.head.appendChild(style);

      this.observeAttrChange('visible', this._attrChanged);
      this.hideMenu = this._hideMenu.bind(this);
    }

    connectedCallback() {
      document.addEventListener('click', this.hideMenu);
    }

    disconnectedCallback() {
      document.removeEventListener('click', this.hideMenu);
    }

    observeAttrChange(attrNames, callback) {
      var observer = new MutationObserver(mutations => {
        mutations.forEach(mutation => {
          if (mutation.type === 'attributes' && ([].concat(attrNames)).includes(mutation.attributeName)) {
            let newVal = mutation.target.getAttribute(mutation.attributeName);
            callback.apply(this, [mutation.attributeName, newVal]);
          }
        });
      });
      observer.observe(this, {attributes: true});
      return observer;
    }

    _attrChanged(attr, newVal) {
      if (newVal === '') {
        Array.from(document.querySelectorAll('a-menu')).forEach(menu => {
          (this.isSameNode(menu) === false) && menu.removeAttribute('visible');
        });
        this.justShown = true; // in case when attribute is changed by outside of this
        setTimeout(_ => this.justShown = false, 100);
      }
    }

    _hideMenu(event) {
      if (!this.justShown && !this.contains(event.target)) {
        this.removeAttribute('visible');
      }
    }

  }
  
  customElements.define('a-menu', Menu);
})();
</script>