<!--
https://material.io/guidelines/components/dialogs.html#dialogs-specs
-->
<template for="Dialog">
  <style id="a-dialog-style">
    a-dialog {
      position: absolute;
    }
    a-dialog[visible] {
      visibility: visible;
      z-index: 24;
    }
    a-dialog:not([visible]) {
      visibility: hidden;
    }
    a-dialog > .page-blocker {
      position: fixed;
      background-color: #000;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: .5;
      top: 0;
    }
    a-dialog > .container {
      padding: 24px;
      position:fixed;
      left: 50%;
      top: 50%;
      -ms-transform: translate(-50%,-50%);
      -moz-transform:translate(-50%,-50%);
      -webkit-transform: translate(-50%,-50%);
      transform: translate(-50%,-50%);
      min-width: 280px; /* 56 x 5 */
      max-width: calc(100% - 80px);
      box-shadow: var(--theme-shadow-10dp);
      border: 1px solid var(--theme-color-200);
      border-radius: var(--theme-border-radius);
      background-color: var(--theme-color-0);
    }
    a-dialog > .container .divider {
      display: block;
      margin: 0px -24px;
      height: 1px;
      border: 1px solid #ccc;
      border-width: 0 0 1px 0;
    }
    a-dialog > .container .title {
      color: var(--theme-text-color-900);
      padding-bottom: 20px;
      font-size: var(--theme-title-font-size);
      font-weight: var(--theme-title-font-weight);
      margin: 0;
    }
    a-dialog > .container .content {
      padding-bottom: 24px;
      color: var(--theme-text-color-500);
    }
    a-dialog > .container .actions {
      padding: 8px;
      margin-right: -16px;
      margin-bottom: -16px;
      text-align: right;
    }
    a-dialog > .container .actions > * {
      display: inline-block;
      margin-left: 8px;
      padding: 8px 0px;
      min-width: 64px;
      height: 36px;
      line-height: 36px;
      font-size: 14px;
      text-transform: uppercase;
      text-align: center;
    }
  </style>
</template>

<script>
( function() {
  var thisScript = document.currentScript;

  class Dialog extends HTMLElement {
    constructor() {
      super();
      let template = thisScript.ownerDocument.querySelector('template[for=Dialog]');
      let style = template.content.querySelector('style').cloneNode(true);
      !document.querySelector(`#ce-core-style, #${style.id}`) && document.head.appendChild(style);
      
      this._regroupElements();
      this.originalPos;
    }

    connectedCallback() {}
    disconnectedCallback() {}

    open(data) {
      //replace title, content, actions with data given
      data && this._updateContent(data);

      // move to document-level for z-indexing to work
      this.originalPos = {parent: this.parentElement, nextSibling: this.nextElementSibling};
      document.body.appendChild(this);
      document.body.style.overflow = 'hidden';
      this.setAttribute('visible', '');
    }

    close() {
      // move back to the original position
      this.originalPos.parent.insertBefore(this, this.originalPos.nextSibling);
      document.body.style.overflow = '';
      this.removeAttribute('visible');
    }
 
    _regroupElements() {
      let pageBlockerEl, containerEl;
      pageBlockerEl = document.createElement('div');
      pageBlockerEl.setAttribute('class', 'page-blocker');
      pageBlockerEl.addEventListener('click', () => {
        this.close();
      });
      this.appendChild(pageBlockerEl);

      containerEl = document.createElement('div');
      containerEl.setAttribute('class', 'container');
      this.appendChild(containerEl);

      Array.from(this.children).forEach(el => {
        if (el.tagName !== 'STYLE' && !el.isSameNode(containerEl) && !el.isSameNode(pageBlockerEl)) {
          containerEl.appendChild(el)
        }
      });
    }

    _updateContent(data) {
      let titleEl, contentEl, actionsEl;
      let appendEl = className  => {
        let el = document.createElement('div');
        el.classList.add(className);
        this.appendChild(el);
        return el;
      }
      if (data.title !== undefined) {
        console.log(1, this.querySelector('.title'), this.innerHTML)
        titleEl = this.querySelector('.title') || appendEl('title');
        titleEl.innerHTML = data.title;
      }
      if (data.contents !== undefined) {
        console.log(2, this.querySelector('.content'), this.innerHTML)
        contentEl = this.querySelector('.content') || appendEl('content');
        contentEl.innerHTML = data.contents;
      }
      if (data.actions !== undefined) {
        console.log(3, this.querySelector('.actions'), this.innerHTML)
        actionsEl = this.querySelector('.actions') || appendEl('actions');
        actionsEl.innerHTML = '';
        for (var key in data.actions) {
          let buttonEl = document.createElement('button');
          buttonEl.innerHTML = key;
          buttonEl.addEventListener('click', _ => {
            data.actions[key]();
            this.close();
          });
          actionsEl.appendChild(buttonEl);
        }
      }
    }
  }
  
  customElements.define('a-dialog', Dialog);
})();
</script>